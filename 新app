import streamlit as st
import pandas as pd
import json
import uuid
import random
from datetime import datetime
from openai import OpenAI
import io

# ==================== åˆå§‹åŒ– ====================
def init_session_state():
    """åˆå§‹åŒ– session_state"""
    if "user_id" not in st.session_state:
        st.session_state.user_id = str(uuid.uuid4())[:8]
    
    if "group" not in st.session_state:
        st.session_state.group = random.choice(["Control", "A", "B"])
    
    if "log_data" not in st.session_state:
        st.session_state.log_data = []
    
    if "chat_history" not in st.session_state:
        st.session_state.chat_history = []
    
    if "task_completed" not in st.session_state:
        st.session_state.task_completed = False
    
    if "ai_content" not in st.session_state:
        st.session_state.ai_content = ""
    
    if "selected_resume" not in st.session_state:
        st.session_state.selected_resume = None

# ==================== ç®€å†æ•°æ® ====================
RESUMES = {
    "å¼ ä¸‰": {
        "content": "æ•™è‚²èƒŒæ™¯ï¼šè®¡ç®—æœºç§‘å­¦å­¦å£«\nå·¥ä½œç»éªŒï¼š5å¹´äººåŠ›èµ„æºç®¡ç†ç»éªŒï¼Œä¸»è¦è´Ÿè´£æ‹›è˜å’Œå‘˜å·¥åŸ¹è®­\næŠ€èƒ½ï¼šExcelã€SAPäººåŠ›èµ„æºç³»ç»Ÿ\næˆå°±ï¼šå»ºç«‹æ ¡å›­æ‹›è˜æ¸ é“ï¼Œæå‡æ‹›è˜æ•ˆç‡30%"
    },
    "æå››": {
        "content": "æ•™è‚²èƒŒæ™¯ï¼šå¿ƒç†å­¦åšå£«\nå·¥ä½œç»éªŒï¼š8å¹´äººåŠ›èµ„æºå’¨è¯¢ç»éªŒï¼Œç»„ç»‡å‘å±•ä¸“å®¶\næŠ€èƒ½ï¼šå‘˜å·¥æµ‹è¯„ã€ç»„ç»‡æ–‡åŒ–å»ºè®¾ã€è–ªé…¬è®¾è®¡\næˆå°±ï¼šä¸º10å®¶ä¼ä¸šåˆ¶å®šäººæ‰å‘å±•æˆ˜ç•¥ï¼Œå‘˜å·¥æ»¡æ„åº¦æå‡25%"
    },
    "ç‹äº”": {
        "content": "æ•™è‚²èƒŒæ™¯ï¼šMBA\nå·¥ä½œç»éªŒï¼š3å¹´åˆçº§HR\næŠ€èƒ½ï¼šåŸºç¡€HRç®¡ç†ã€æ‹›è˜\næˆå°±ï¼šå®Œæˆ200+ä¸ªæ‹›è˜é¡¹ç›®"
    },
    "èµµå…­": {
        "content": "æ•™è‚²èƒŒæ™¯ï¼šäººåŠ›èµ„æºç®¡ç†å­¦å£«\nå·¥ä½œç»éªŒï¼š10å¹´å¤§å‹ä¼ä¸šHRç»ç†ï¼Œç®¡ç†500+å‘˜å·¥\næŠ€èƒ½ï¼šæˆ˜ç•¥è§„åˆ’ã€å…¨é¢è–ªé…¬ç®¡ç†ã€ç»©æ•ˆç®¡ç†ã€åŠ³åŠ¨å…³ç³»\næˆå°±ï¼šä¼˜åŒ–è–ªé…¬ä½“ç³»ï¼Œé™ä½ç¦»èŒç‡15%ï¼Œè·å¾—æœ€ä½³HRå¥–"
    }
}

# ==================== AI æ£€æµ‹å’ŒéªŒè¯å‡½æ•° ====================
def check_ai_response_quality(content: str) -> dict:
    """æ£€æŸ¥ AI å›å¤è´¨é‡"""
    issues = []
    
    # æ£€æŸ¥è¡¨æ ¼ç¬¦å·
    if "|" not in content:
        issues.append("æœªæ£€æµ‹åˆ°è¡¨æ ¼ç¬¦å· '|'ï¼Œè¯·ä½¿ç”¨ Markdown è¡¨æ ¼æ ¼å¼")
    
    # æ£€æŸ¥å­—æ•°
    char_count = len(content.replace(" ", "").replace("\n", ""))
    if char_count > 600:
        issues.append(f"å†…å®¹å­—æ•°è¿‡é•¿ï¼ˆ{char_count} å­— > 600 å­—é™åˆ¶ï¼‰ï¼Œè¯·ç²¾ç®€å†…å®¹")
    
    # æ£€æŸ¥æ ‡å‡†æ•°é‡ï¼ˆé€šè¿‡è®¡æ•° | æ¥ä¼°è®¡è¡Œæ•°ï¼‰
    lines = content.split("\n")
    table_lines = [l for l in lines if "|" in l]
    # æ ‡å‡†è¡Œåº”è¯¥æ˜¯è¡¨æ ¼è¡Œæ•°å‡å»æ ‡é¢˜å’Œåˆ†éš”è¡Œ
    standard_lines = max(0, len(table_lines) - 2)
    if standard_lines < 3:
        issues.append(f"æ ‡å‡†è¡Œæ•°ä¸è¶³ï¼ˆéœ€è‡³å°‘ 3 è¡Œï¼Œå½“å‰ {standard_lines} è¡Œï¼‰")
    
    return {
        "is_valid": len(issues) == 0,
        "issues": issues,
        "char_count": char_count,
        "table_lines": len(table_lines)
    }

# ==================== æ—¥å¿—è®°å½• ====================
def log_interaction(action: str, content: str = "", details: dict = None):
    """è®°å½•äº¤äº’"""
    log_entry = {
        "timestamp": datetime.now().isoformat(),
        "user_id": st.session_state.user_id,
        "group": st.session_state.group,
        "action": action,
        "content": content[:200] if content else "",  # æˆªæ–­é•¿å†…å®¹
        "details": details or {}
    }
    st.session_state.log_data.append(log_entry)

# ==================== AI äº¤äº’ ====================
def call_deepseek_api(prompt: str) -> str:
    """è°ƒç”¨ DeepSeek API"""
    try:
        client = OpenAI(
            api_key="sk-a05915657f7841b382145bc4c2e45749",
            base_url="https://api.deepseek.com"
        )
        
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„äººåŠ›èµ„æºé¡¾é—®ï¼Œå¸®åŠ©HRç»ç†è¿›è¡Œæ‹›è˜å†³ç­–ã€‚"},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=2000
        )
        
        return response.choices[0].message.content
    except Exception as e:
        return f"API è°ƒç”¨å‡ºé”™ï¼š{str(e)}"

# ==================== UI ç»„ä»¶ ====================
def render_sidebar():
    """ä¾§è¾¹æ """
    with st.sidebar:
        st.title("ğŸ“‹ å®éªŒä¿¡æ¯")
        
        st.info(f"**ç”¨æˆ· ID**: {st.session_state.user_id}\n\n**åˆ†é…ç»„åˆ«**: {st.session_state.group}")
        
        st.divider()
        st.subheader("âœ… ä»»åŠ¡è¦æ±‚")
        st.markdown("""
        1. **é€‰æ‹©å€™é€‰äºº**ï¼šä»4ä»½ç®€å†ä¸­é€‰æ‹©1ä½
        2. **ç»™å‡ºæ ‡å‡†**ï¼šè‡³å°‘3ä¸ªè¯„ä¼°æ ‡å‡†
        3. **å­—æ•°é™åˆ¶**ï¼šæ¯ä¸ªæ ‡å‡†ä¸è¶…200å­—
        4. **æ ¼å¼è¦æ±‚**ï¼šå¿…é¡»ä½¿ç”¨Markdownè¡¨æ ¼å‘ˆç°
        5. **ä¸“ä¸šæ€§**ï¼šä½¿ç”¨HRä¸“ä¸šè¯­è¨€
        """)
        
        st.divider()
        st.subheader("ğŸ“Š ç»„åˆ«è¯´æ˜")
        if st.session_state.group == "Control":
            st.success("**Controlç»„**ï¼šæ— ä»»ä½•å¹²é¢„ï¼Œè‡ªä¸»å®Œæˆä»»åŠ¡")
        elif st.session_state.group == "A":
            st.warning("**Aç»„**ï¼šæ£€æµ‹åˆ°é”™è¯¯æ—¶å¼¹çª—æç¤ºå¹¶æä¾›ä¿®å¤å»ºè®®")
        else:  # B
            st.info("**Bç»„**ï¼šå§‹ç»ˆæ˜¾ç¤ºå¼•å¯¼æŒ‰é’®ï¼Œè¾…åŠ©ä¼˜åŒ–å›å¤")

def render_resume_selection():
    """ç®€å†é€‰æ‹©åŒºåŸŸ"""
    st.subheader("ğŸ“„ å€™é€‰äººç®€å†")
    
    cols = st.columns(4)
    with cols[0]:
        if st.button("å¼ ä¸‰", use_container_width=True, key="resume_å¼ ä¸‰"):
            st.session_state.selected_resume = "å¼ ä¸‰"
            log_interaction("select_resume", "å¼ ä¸‰")
    with cols[1]:
        if st.button("æå››", use_container_width=True, key="resume_æå››"):
            st.session_state.selected_resume = "æå››"
            log_interaction("select_resume", "æå››")
    with cols[2]:
        if st.button("ç‹äº”", use_container_width=True, key="resume_ç‹äº”"):
            st.session_state.selected_resume = "ç‹äº”"
            log_interaction("select_resume", "ç‹äº”")
    with cols[3]:
        if st.button("èµµå…­", use_container_width=True, key="resume_èµµå…­"):
            st.session_state.selected_resume = "èµµå…­"
            log_interaction("select_resume", "èµµå…­")
    
    if st.session_state.selected_resume:
        st.success(f"âœ… å·²é€‰æ‹©ï¼š{st.session_state.selected_resume}")
        with st.expander("æŸ¥çœ‹å®Œæ•´ç®€å†"):
            st.write(RESUMES[st.session_state.selected_resume]["content"])

def render_chat_interface():
    """å¯¹è¯ç•Œé¢"""
    if not st.session_state.selected_resume:
        st.info("â¬†ï¸ è¯·å…ˆä»ä¸Šæ–¹é€‰æ‹©ä¸€ä½å€™é€‰äºº")
        return
    
    # æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ
    for msg in st.session_state.chat_history:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])
    
    # ç”¨æˆ·è¾“å…¥
    user_input = st.chat_input("è¯·è¾“å…¥æ‚¨çš„åˆ†æ...")
    
    if user_input:
        # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        st.session_state.chat_history.append({"role": "user", "content": user_input})
        log_interaction("user_message", user_input)
        
        with st.chat_message("user"):
            st.markdown(user_input)
        
        # AI å›å¤
        with st.chat_message("assistant"):
            with st.spinner("AI æ€è€ƒä¸­..."):
                prompt = f"""ä½œä¸ºHRé¡¾é—®ï¼Œè¯·å¯¹ä»¥ä¸‹å€™é€‰äººè¿›è¡Œä¸“ä¸šè¯„ä¼°ï¼š

å€™é€‰äººï¼š{st.session_state.selected_resume}
ç®€å†ä¿¡æ¯ï¼š
{RESUMES[st.session_state.selected_resume]['content']}

ç”¨æˆ·æ„è§ï¼š{user_input}

è¯·åŸºäºæ­¤æä¾›ï¼š
1. è‡³å°‘3ä¸ªHRç›¸å…³è¯„ä¼°æ ‡å‡†
2. æ¯ä¸ªæ ‡å‡†ç»™å‡ºè¯¦ç»†è¯´æ˜ï¼ˆä¸è¶…200å­—ï¼‰
3. å¿…é¡»ä½¿ç”¨Markdownè¡¨æ ¼æ ¼å¼å‘ˆç°ç»“æœ

è¡¨æ ¼ç¤ºä¾‹ï¼š
| è¯„ä¼°æ ‡å‡† | è¯´æ˜ |
|--------|------|
| æ ‡å‡†1 | è¯´æ˜å†…å®¹ |
| æ ‡å‡†2 | è¯´æ˜å†…å®¹ |
| æ ‡å‡†3 | è¯´æ˜å†…å®¹ |
"""
                ai_response = call_deepseek_api(prompt)
                st.session_state.ai_content = ai_response
                st.markdown(ai_response)
                log_interaction("ai_response", ai_response)
        
        # ==================== A ç»„ï¼šé”™è¯¯æ£€æµ‹ ====================
        if st.session_state.group == "A":
            quality_check = check_ai_response_quality(ai_response)
            if not quality_check["is_valid"]:
                # æ˜¾ç¤ºè­¦å‘Š
                for issue in quality_check["issues"]:
                    st.toast(f"âš ï¸ {issue}", icon="âš ï¸")
                
                # ä¿®å¤å»ºè®®æŒ‰é’®
                st.divider()
                st.subheader("ğŸ”§ æ£€æµ‹åˆ°é—®é¢˜ï¼Œä»¥ä¸‹æ˜¯ä¿®å¤å»ºè®®")
                
                cols = st.columns(2)
                with cols[0]:
                    if st.button("ä¿®å¤ï¼šæ·»åŠ /å®Œå–„è¡¨æ ¼", key="fix_table"):
                        with st.spinner("ä¿®å¤ä¸­..."):
                            fix_prompt = f"è¯·å°†ä»¥ä¸‹å†…å®¹æ”¹è¿›ä¸ºè§„èŒƒçš„Markdownè¡¨æ ¼æ ¼å¼ï¼Œç¡®ä¿åŒ…å«è‡³å°‘3è¡Œæ ‡å‡†ï¼š\n\n{ai_response}"
                            fixed = call_deepseek_api(fix_prompt)
                            st.session_state.ai_content = fixed
                            st.session_state.chat_history[-1]["content"] = fixed
                            log_interaction("ai_fix", fixed, {"fix_type": "table"})
                            st.success("âœ… å·²ä¿®å¤ï¼")
                            st.rerun()
                
                with cols[1]:
                    if st.button("ä¿®å¤ï¼šç²¾ç®€å­—æ•°", key="fix_length"):
                        with st.spinner("ä¿®å¤ä¸­..."):
                            fix_prompt = f"è¯·ç²¾ç®€ä»¥ä¸‹å†…å®¹è‡³600å­—ä»¥å†…ï¼Œä¿æŒä¸“ä¸šæ€§ï¼š\n\n{ai_response}"
                            fixed = call_deepseek_api(fix_prompt)
                            st.session_state.ai_content = fixed
                            st.session_state.chat_history[-1]["content"] = fixed
                            log_interaction("ai_fix", fixed, {"fix_type": "length"})
                            st.success("âœ… å·²ä¿®å¤ï¼")
                            st.rerun()
        
        # ==================== B ç»„ï¼šå¼•å¯¼æŒ‰é’® ====================
        elif st.session_state.group == "B":
            st.divider()
            st.subheader("ğŸ’¡ å†…å®¹ä¼˜åŒ–å»ºè®®")
            
            cols = st.columns(3)
            with cols[0]:
                if st.button("å¼ºåŒ– HR ä¸“ä¸šè¯­æ°”", use_container_width=True, key="enhance_professional"):
                    with st.spinner("ä¼˜åŒ–ä¸­..."):
                        enhance_prompt = f"è¯·ç”¨æ›´ä¸“ä¸šçš„HRæœ¯è¯­å’Œè¡¨è¿°æ–¹å¼é‡æ–°ç»„ç»‡ä»¥ä¸‹å†…å®¹ï¼Œä¿æŒåŸæ„ä¸å˜ï¼š\n\n{ai_response}"
                        enhanced = call_deepseek_api(enhance_prompt)
                        st.session_state.ai_content = enhanced
                        st.session_state.chat_history[-1]["content"] = enhanced
                        log_interaction("ai_enhance", enhanced, {"enhance_type": "professional"})
                        st.success("âœ… å·²ä¼˜åŒ–ï¼")
                        st.rerun()
            
            with cols[1]:
                if st.button("å°†ç»“æœè½¬ä¸ºè¡¨æ ¼", use_container_width=True, key="convert_table"):
                    with st.spinner("è½¬æ¢ä¸­..."):
                        table_prompt = f"è¯·å°†ä»¥ä¸‹å†…å®¹é‡æ–°ç»„ç»‡ä¸ºè§„èŒƒçš„Markdownè¡¨æ ¼ï¼Œè‡³å°‘åŒ…å«3è¡Œæ•°æ®ï¼š\n\n{ai_response}"
                        tabled = call_deepseek_api(table_prompt)
                        st.session_state.ai_content = tabled
                        st.session_state.chat_history[-1]["content"] = tabled
                        log_interaction("ai_enhance", tabled, {"enhance_type": "table"})
                        st.success("âœ… å·²è½¬æ¢ï¼")
                        st.rerun()
            
            with cols[2]:
                if st.button("ä¸¥æ ¼ç²¾ç®€å­—æ•°", use_container_width=True, key="strict_concise"):
                    with st.spinner("ç²¾ç®€ä¸­..."):
                        concise_prompt = f"è¯·å°†ä»¥ä¸‹å†…å®¹ä¸¥æ ¼ç²¾ç®€è‡³600å­—ä»¥å†…ï¼Œä¿æŒæ ¸å¿ƒä¿¡æ¯å®Œæ•´ï¼š\n\n{ai_response}"
                        concised = call_deepseek_api(concise_prompt)
                        st.session_state.ai_content = concised
                        st.session_state.chat_history[-1]["content"] = concised
                        log_interaction("ai_enhance", concised, {"enhance_type": "concise"})
                        st.success("âœ… å·²ç²¾ç®€ï¼")
                        st.rerun()

# ==================== å¯¼å‡ºåŠŸèƒ½ ====================
def export_csv():
    """å¯¼å‡ºæ•°æ®ä¸ºCSV"""
    if not st.session_state.log_data:
        st.warning("æš‚æ— æ•°æ®è®°å½•")
        return None
    
    df = pd.DataFrame(st.session_state.log_data)
    csv = df.to_csv(index=False).encode('utf-8-sig')
    return csv

# ==================== ä¸»ç¨‹åº ====================
def main():
    st.set_page_config(
        page_title="ç”Ÿæˆå¼AIé»˜è®¤æ•ˆåº”å®éªŒ",
        page_icon="ğŸ”¬",
        layout="wide"
    )
    
    st.title("ğŸ”¬ ç”Ÿæˆå¼ AI é»˜è®¤æ•ˆåº”ç ”ç©¶å®éªŒ")
    st.markdown("**ç ”ç©¶ 4**: HR æ‹›è˜å†³ç­–ä¸­çš„ AI é»˜è®¤æ•ˆåº”")
    
    # åˆå§‹åŒ–
    init_session_state()
    
    # æ¸²æŸ“ä¾§è¾¹æ 
    render_sidebar()
    
    # ä¸»è¦å†…å®¹åŒºåŸŸ
    col1, col2 = st.columns([1, 2])
    
    with col1:
        render_resume_selection()
    
    with col2:
        render_chat_interface()
    
    # åº•éƒ¨ï¼šå¯¼å‡ºæŒ‰é’®
    st.divider()
    st.subheader("ğŸ“¥ å¯¼å‡ºæ•°æ®")
    
    cols = st.columns(2)
    with cols[0]:
        csv_data = export_csv()
        if csv_data:
            st.download_button(
                label="ä¸‹è½½å®éªŒæ•°æ® (CSV)",
                data=csv_data,
                file_name=f"experiment_data_{st.session_state.user_id}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                mime="text/csv",
                key="download_csv"
            )
    
    with cols[1]:
        if st.button("âœ… ç»“æŸå®éªŒå¹¶å¯¼å‡º", key="end_experiment"):
            st.session_state.task_completed = True
            csv_data = export_csv()
            if csv_data:
                st.success("âœ… å®éªŒå·²å®Œæˆï¼æ•°æ®å·²å¯¼å‡º")
                log_interaction("experiment_completed")
            else:
                st.info("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º")
    
    # è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    with st.expander("ğŸ“Š è°ƒè¯•ä¿¡æ¯"):
        st.json({
            "user_id": st.session_state.user_id,
            "group": st.session_state.group,
            "log_count": len(st.session_state.log_data),
            "selected_resume": st.session_state.selected_resume
        })

if __name__ == "__main__":
    main()
